name: Check Ticket Number in Pull Request Description

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  check_ticket_in_pr_description:
    runs-on: ubuntu-latest

    steps:
      - name: Check pull request description for ticket number
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TICKET_PATTERN="^\s*(Ticket:\s*)?([A-Z]+-[0-9]+|NA)\s*$"

          pr_description=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }} | jq -r .body)

          if [[ ! "$pr_description" =~ $TICKET_PATTERN ]]; then
            echo "The pull request description does not contain a valid ticket number or 'Ticket: NA'."
            exit 1
          fi

          echo "The pull request description contains a valid ticket format or 'Ticket: NA'."
